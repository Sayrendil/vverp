# ‚úÖ –†–µ–∞–ª–∏–∑–∞—Ü–∏—è Telegram Workflow –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞—è–≤–∫–∞–º–∏

## üéØ –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω **–ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞—è–≤–∫–∞–º–∏ —á–µ—Ä–µ–∑ Telegram** —Å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏:

### 1. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è–º –æ –Ω–æ–≤—ã—Ö –∑–∞—è–≤–∫–∞—Ö ‚úÖ

- –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞—è–≤–∫–∏ –í–°–ï –∞–∫—Ç–∏–≤–Ω—ã–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–ª—É—á–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞—è–≤–∫–µ
- –ö–Ω–æ–ø–∫–∏ –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π

### 2. Workflow —Å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏ ‚úÖ

```
üìù –°–û–ó–î–ê–ù–ê
    ‚Üì
    [‚úÖ –í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É] ‚Üê –õ—é–±–æ–π –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    ‚Üì
‚öôÔ∏è –í –†–ê–ë–û–¢–ï
    ‚Üì
    [‚è∏Ô∏è –û—Ç–ª–æ–∂–∏—Ç—å]  –∏–ª–∏  [‚úÖ –ù–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ]
    ‚Üì
‚úÖ –ù–ê –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ò
    ‚Üì
    [‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å] ‚Üê –ê–≤—Ç–æ—Ä –∑–∞—è–≤–∫–∏
    ‚Üì
üéâ –ó–ê–í–ï–†–®–ï–ù–ê
```

**–ê–≤—Ç–æ—Ä —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å –∑–∞—è–≤–∫—É**: [‚ùå –í–µ—Ä–Ω—É—Ç—å –≤ —Ä–∞–±–æ—Ç—É]

### 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–∞ –≤—Å–µ—Ö —ç—Ç–∞–ø–∞—Ö ‚úÖ

- –ê–≤—Ç–æ—Ä—É –ø—Ä–∏ –≤–∑—è—Ç–∏–∏ –≤ —Ä–∞–±–æ—Ç—É
- –ê–≤—Ç–æ—Ä—É –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
- –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—é –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏/–≤–æ–∑–≤—Ä–∞—Ç–µ
- –ê–≤—Ç–æ—Ä—É –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏

## üìÅ –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã:

1. **`app/Services/Telegram/TicketWorkflowService.php`**
   - –í—Å—è –ª–æ–≥–∏–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞—è–≤–∫–∞–º–∏
   - –ú–µ—Ç–æ–¥—ã: takeToWork, postponeTicket, sendForConfirmation, confirmCompletion, rejectCompletion

2. **`app/Listeners/SendTicketCreatedNotificationToExecutors.php`**
   - –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤—Å–µ–º –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
   - –î–æ–±–∞–≤–ª—è–µ—Ç –∫–Ω–æ–ø–∫–∏ –∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º

3. **`app/Console/Commands/TestExecutorNotifications.php`**
   - –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

4. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**:
   - `docs/EXECUTOR_NOTIFICATIONS.md` - –î–µ—Ç–∞–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
   - `docs/TICKET_WORKFLOW_TELEGRAM.md` - –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è workflow
   - `docs/QUICK_START_WORKFLOW.md` - –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
   - `TELEGRAM_WORKFLOW_SUMMARY.md` - –≠—Ç–æ—Ç —Ñ–∞–π–ª

### –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:

1. **`app/Services/Telegram/Handlers/CallbackQueryHandler.php`**
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤—ã—Ö callback –¥–µ–π—Å—Ç–≤–∏–π (take_work, postpone, send_confirmation, etc.)

2. **`app/Console/Commands/TelegramBotPolling.php`**
   - –î–æ–±–∞–≤–ª–µ–Ω TicketWorkflowService –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

3. **`app/Providers/EventServiceProvider.php`**
   - –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –Ω–æ–≤—ã–π listener –¥–ª—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π

## üöÄ –ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å

### 1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞ (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –∑–∞–ø—É—â–µ–Ω)

```bash
php artisan telegram:polling

# –ò–ª–∏ —á–µ—Ä–µ–∑ docker
docker exec -it vverp_app php artisan telegram:polling
```

### 2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—á–µ—Ä–µ–¥–µ–π

```bash
php artisan queue:work --queue=notifications --tries=3

# –ò–ª–∏ —á–µ—Ä–µ–∑ docker
docker exec -it vverp_app php artisan queue:work --queue=notifications
```

### 3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π

1. –ó–∞–π–¥–∏—Ç–µ –Ω–∞ `/executors` –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
2. –î–æ–±–∞–≤—å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∫–∞–∫ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
3. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –æ–Ω–∏ –∞–∫—Ç–∏–≤–Ω—ã (`is_active = true`)

### 4. –ü—Ä–∏–≤—è–∂–∏—Ç–µ Telegram ID

–ö–∞–∂–¥—ã–π –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω:
1. –ù–∞–π—Ç–∏ –≤–∞—à–µ–≥–æ –±–æ—Ç–∞ –≤ Telegram
2. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É `/start`
3. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç –µ–≥–æ `telegram_id`

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é –∫–æ–º–∞–Ω–¥—É
php artisan test:executor-notifications

# –ò–ª–∏ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∑–∞—è–≤–∫–æ–π
php artisan test:executor-notifications 123
```

### –ü–æ–ª–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π

```bash
# 1. –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é –∑–∞—è–≤–∫—É
php artisan tinker
>>> $ticket = App\Models\Ticket::factory()->create([
...   'ticket_category_id' => 2,
...   'status_id' => 1,
... ]);
>>> event(new App\Events\TicketCreated($ticket));

# 2. –û—Ç–∫—Ä–æ–π—Ç–µ Telegram
# 3. –ù–∞–∂–º–∏—Ç–µ "–í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É"
# 4. –ù–∞–∂–º–∏—Ç–µ "–ù–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ"
# 5. –û—Ç –∏–º–µ–Ω–∏ –∞–≤—Ç–æ—Ä–∞ –Ω–∞–∂–º–∏—Ç–µ "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å"
```

## üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

### –ï—Å—Ç—å –ª–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏?

```sql
SELECT
    u.name,
    u.telegram_id,
    tc.name as category,
    ce.is_active
FROM users u
JOIN category_executors ce ON u.id = ce.user_id
JOIN ticket_categories tc ON ce.ticket_category_id = tc.id
WHERE ce.is_active = true AND u.telegram_id IS NOT NULL;
```

### –†–∞–±–æ—Ç–∞–µ—Ç –ª–∏ –±–æ—Ç?

```bash
ps aux | grep telegram:polling
```

### –†–∞–±–æ—Ç–∞–µ—Ç –ª–∏ –æ—á–µ—Ä–µ–¥—å?

```bash
ps aux | grep "queue:work"
```

## üé¨ –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞

1. **–°–æ—Ç—Ä—É–¥–Ω–∏–∫** —Å–æ–∑–¥–∞–µ—Ç –∑–∞—è–≤–∫—É —á–µ—Ä–µ–∑ Telegram –∏–ª–∏ Web
2. **–°–∏—Å—Ç–µ–º–∞** –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤—Å–µ–º –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:

```
üÜï –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ #123

üìÅ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: IT –ø–æ–¥–¥–µ—Ä–∂–∫–∞
üè™ –ú–∞–≥–∞–∑–∏–Ω: –í–∫—É—Å–í–∏–ª–ª –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π
‚ùó –ü—Ä–æ–±–ª–µ–º–∞: –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞—Å—Å–∞
üë§ –ê–≤—Ç–æ—Ä: –ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω

üìù –ö–∞—Å—Å–∞ ‚Ññ3 –Ω–µ –≤–∫–ª—é—á–∞–µ—Ç—Å—è
‚è∞ –°–æ–∑–¥–∞–Ω–∞: 17.11.2024 14:30

[ ‚úÖ –í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É ]
[  üëÅ –ü–æ–¥—Ä–æ–±–Ω–µ–µ    ]
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –í–∑—è—Ç–∏–µ –≤ —Ä–∞–±–æ—Ç—É

1. **–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å** –Ω–∞–∂–∏–º–∞–µ—Ç "–í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É"
2. **–°–∏—Å—Ç–µ–º–∞**:
   - –ù–∞–∑–Ω–∞—á–∞–µ—Ç –µ–≥–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–º
   - –ú–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å –Ω–∞ "–í —Ä–∞–±–æ—Ç–µ"
   - –£–≤–µ–¥–æ–º–ª—è–µ—Ç –∞–≤—Ç–æ—Ä–∞
   - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—é –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

```
üìå –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–æ–π

–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:

[  ‚è∏Ô∏è –û—Ç–ª–æ–∂–∏—Ç—å      ]
[ ‚úÖ –ù–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ ]
[  üëÅ –ü–æ–¥—Ä–æ–±–Ω–µ–µ     ]
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ

1. **–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å** –Ω–∞–∂–∏–º–∞–µ—Ç "–ù–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ"
2. **–ê–≤—Ç–æ—Ä** –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:

```
‚úÖ –ó–∞—è–≤–∫–∞ #123 –≤—ã–ø–æ–ª–Ω–µ–Ω–∞

üè™ –ú–∞–≥–∞–∑–∏–Ω: –í–∫—É—Å–í–∏–ª–ª –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π
‚ùó –ü—Ä–æ–±–ª–µ–º–∞: –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞—Å—Å–∞
üë§ –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: –ü–µ—Ç—Ä–æ–≤ –ü–µ—Ç—Ä

üìù –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ:

[ ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ ]
[   ‚ùå –í–µ—Ä–Ω—É—Ç—å –≤ —Ä–∞–±–æ—Ç—É     ]
```

3. **–ê–≤—Ç–æ—Ä** –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç
4. **–°–∏—Å—Ç–µ–º–∞** –∑–∞–≤–µ—Ä—à–∞–µ—Ç –∑–∞—è–≤–∫—É –∏ —É–≤–µ–¥–æ–º–ª—è–µ—Ç –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è

## üìù –õ–æ–≥–∏ –∏ –æ—Ç–ª–∞–¥–∫–∞

### –°–ª–µ–¥–∏—Ç—å –∑–∞ –ª–æ–≥–∞–º–∏

```bash
tail -f storage/logs/laravel.log | grep -E "executor|workflow|ticket"
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

```bash
grep "Notification sent to executor" storage/logs/laravel.log
```

### –ù–∞–π—Ç–∏ –æ—à–∏–±–∫–∏

```bash
grep "Failed to send" storage/logs/laravel.log
```

## üéâ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!

–°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é:

‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è–º
‚úÖ –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
‚úÖ –ü–æ–ª–Ω—ã–π workflow (—Å–æ–∑–¥–∞–Ω–∏–µ ‚Üí —Ä–∞–±–æ—Ç–∞ ‚Üí –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ ‚Üí –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ)
‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π
‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
‚úÖ –¢–µ—Å—Ç–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã
‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ

- **–ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è workflow**: `docs/TICKET_WORKFLOW_TELEGRAM.md`
- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π**: `docs/EXECUTOR_NOTIFICATIONS.md`
- **–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç**: `docs/QUICK_START_WORKFLOW.md`

---

**–°–æ–∑–¥–∞–Ω–æ**: 17.11.2024
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ
