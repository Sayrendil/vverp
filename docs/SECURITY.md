# Безопасность системы тикетов

## Реализованные механизмы безопасности

### 1. **Policy (TicketPolicy.php)**

Контроль доступа к тикетам на уровне Laravel Policy.

#### Правила доступа:

**viewAny (Просмотр списка)**
- ✅ Все аутентифицированные пользователи

**view (Просмотр тикета)**
- ✅ Автор тикета
- ✅ Назначенный исполнитель тикета
- ✅ Администраторы своей категории
- ✅ Исполнители категории (активные в таблице category_executors)

**create (Создание)**
- ✅ Все аутентифицированные пользователи

**update (Редактирование)**
- ✅ Автор тикета
- ✅ Исполнитель тикета
- ✅ Администраторы категории (пользователи с установленной категорией)

**delete (Удаление)**
- ✅ Автор тикета
- ✅ Администраторы категории

**updateStatus (Изменение статуса)**
- ✅ Автор тикета
- ✅ Исполнитель тикета
- ✅ Администраторы категории

---

### 2. **FormRequest классы**

#### StoreTicketRequest
- Валидация при создании тикета
- Автоматическая проверка прав доступа
- Пользовательские сообщения об ошибках на русском языке
- Динамическая валидация категории (обязательна только если у пользователя нет своей)

#### UpdateTicketRequest
- Валидация при обновлении тикета
- Проверка существования связанных сущностей
- Русские сообщения об ошибках
- Проверка прав на исполнителя

---

### 3. **Ограничения по категориям**

Пользователи с установленной `ticket_category_id` видят только тикеты своей категории:

```php
// В TicketController@index
->when($user->ticket_category_id, function ($query) use ($user) {
    $query->where('ticket_category_id', $user->ticket_category_id);
})
```

**Примеры:**
- Пользователь категории "Магазин" → видит только тикеты "Магазин"
- Пользователь без категории → видит все тикеты
- Пользователь категории "Офис" → видит только тикеты "Офис"

---

### 4. **Защищенные маршруты**

Все методы контроллера проверяют права доступа:

```php
// Перед показом списка
$this->authorize('viewAny', Ticket::class);

// Перед просмотром тикета
$this->authorize('view', $ticket);

// Перед редактированием
$this->authorize('update', $ticket);

// Перед удалением
$this->authorize('delete', $ticket);
```

---

## Примеры использования

### Создание тикета

**Пользователь с категорией:**
- Категория автоматически устанавливается из профиля
- Поле категории скрыто в форме

**Пользователь без категории:**
- Должен выбрать категорию вручную
- Категория обязательна для заполнения

### Просмотр тикетов

**Сценарий 1: Автор**
```
Пользователь А создал тикет #123
→ Пользователь А может просматривать, редактировать и удалять тикет #123
```

**Сценарий 2: Исполнитель**
```
Тикет #456 назначен Пользователю Б
→ Пользователь Б может просматривать, редактировать и менять статус тикета #456
```

**Сценарий 3: Администратор категории**
```
Пользователь В имеет ticket_category_id = 1 (Магазин)
→ Пользователь В может управлять всеми тикетами категории "Магазин"
```

---

## Что будет при попытке несанкционированного доступа?

Laravel автоматически вернет:
- **403 Forbidden** - если пользователь не имеет прав
- Перенаправление на страницу ошибки

---

## Дальнейшие улучшения

### Рекомендуется добавить:

1. **Роли пользователей** (admin, manager, user)
   ```bash
   composer require spatie/laravel-permission
   ```

2. **История изменений тикетов**
   - Кто и когда изменил статус
   - Кто и что отредактировал

3. **Уведомления**
   - Email при назначении исполнителя
   - Уведомления при изменении статуса

4. **Rate Limiting**
   - Ограничение на создание тикетов (например, 10 в час)

5. **Soft Deletes**
   - Мягкое удаление тикетов вместо жесткого

---

## Тестирование безопасности

```bash
# Запуск тестов
php artisan test --filter TicketPolicyTest
```

Рекомендуется создать тесты для проверки всех сценариев Policy.

---

## Контакты

При обнаружении уязвимостей безопасности, пожалуйста, сообщите команде разработки.
