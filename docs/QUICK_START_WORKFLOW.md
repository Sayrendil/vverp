# üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç - Telegram Workflow –¥–ª—è –∑–∞—è–≤–æ–∫

## –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

‚úÖ **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è–º** –æ –Ω–æ–≤—ã—Ö –∑–∞—è–≤–∫–∞—Ö
‚úÖ **–ö–Ω–æ–ø–∫–∞ "–í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É"** - –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞—è–≤–∫—É
‚úÖ **–ö–Ω–æ–ø–∫–∞ "–û—Ç–ª–æ–∂–∏—Ç—å"** - –≤—Ä–µ–º–µ–Ω–Ω–∞—è –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∫–∞
‚úÖ **–ö–Ω–æ–ø–∫–∞ "–ù–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ"** - –æ—Ç–ø—Ä–∞–≤–∫–∞ –∞–≤—Ç–æ—Ä—É –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É
‚úÖ **–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç –∞–≤—Ç–æ—Ä–∞** - –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏–ª–∏ –≤–æ–∑–≤—Ä–∞—Ç –≤ —Ä–∞–±–æ—Ç—É
‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ

## –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —à–∞–≥–∏ –¥–ª—è –∑–∞–ø—É—Å–∫–∞

### 1. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –±–æ—Ç –∑–∞–ø—É—â–µ–Ω

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å
ps aux | grep telegram:polling

# –ï—Å–ª–∏ –Ω–µ –∑–∞–ø—É—â–µ–Ω - –∑–∞–ø—É—Å—Ç–∏—Ç—å
php artisan telegram:polling

# –ò–ª–∏ —á–µ—Ä–µ–∑ docker
docker exec -it vverp_app php artisan telegram:polling
```

### 2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—á–µ—Ä–µ–¥–µ–π

```bash
# –ó–∞–ø—É—Å–∫ worker –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
php artisan queue:work --queue=notifications --tries=3

# –ò–ª–∏ —á–µ—Ä–µ–∑ docker
docker exec -it vverp_app php artisan queue:work --queue=notifications --tries=3
```

### 3. –î–æ–±–∞–≤—å—Ç–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏

**–ß–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å**: `/executors`

–ò–ª–∏ —á–µ—Ä–µ–∑ API:
```bash
curl -X POST http://your-domain/api/executors \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": 5,
    "category_id": 2,
    "priority": 5,
    "max_tickets": 10
  }'
```

### 4. –ü—Ä–∏–≤—è–∂–∏—Ç–µ Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `/start` –±–æ—Ç—É

**–í—Ä—É—á–Ω—É—é** (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è):
```sql
UPDATE users SET telegram_id = '123456789' WHERE id = 5;
```

–ß—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å —Å–≤–æ–π telegram_id:
- –ù–∞–ø–∏—à–∏—Ç–µ –±–æ—Ç—É [@userinfobot](https://t.me/userinfobot)
- –û–Ω –ø—Ä–∏—à–ª–µ—Ç –≤–∞—à ID

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è–º

```bash
# –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é –∑–∞—è–≤–∫—É
php artisan tinker

>>> $ticket = App\Models\Ticket::factory()->create([
...   'ticket_category_id' => 2,  // ID –≤–∞—à–µ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
...   'status_id' => 1,            // –°–æ–∑–¥–∞–Ω–∞
... ]);

>>> event(new App\Events\TicketCreated($ticket));
```

**–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ**:
- –í—Å–µ–º –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–∏—Ö–æ–¥–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
- –í —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–∏ –µ—Å—Ç—å –∫–Ω–æ–ø–∫–∏ "–í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É" –∏ "–ü–æ–¥—Ä–æ–±–Ω–µ–µ"

### –¢–µ—Å—Ç 2: –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª

1. **–°–æ–∑–¥–∞–π—Ç–µ –∑–∞—è–≤–∫—É** (–∫–∞–∫ –≤ —Ç–µ—Å—Ç–µ 1 –∏–ª–∏ —á–µ—Ä–µ–∑ –≤–µ–±/Telegram)
2. **–û—Ç –∏–º–µ–Ω–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è**: –Ω–∞–∂–º–∏—Ç–µ "–í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É"
3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ**: –∞–≤—Ç–æ—Ä –ø–æ–ª—É—á–∏–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≤–∑—è—Ç–∏–∏ –≤ —Ä–∞–±–æ—Ç—É
4. **–û—Ç –∏–º–µ–Ω–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è**: –Ω–∞–∂–º–∏—Ç–µ "–ù–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ"
5. **–û—Ç –∏–º–µ–Ω–∏ –∞–≤—Ç–æ—Ä–∞**: –Ω–∞–∂–º–∏—Ç–µ "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ"
6. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ**: –∑–∞—è–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ (status_id = 5)

### –¢–µ—Å—Ç 3: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–π –∫–æ–º–∞–Ω–¥—ã

```bash
# –° –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞—è–≤–∫–æ–π
php artisan test:executor-notifications

# –° –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∑–∞—è–≤–∫–æ–π
php artisan test:executor-notifications 123
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –ï—Å—Ç—å –ª–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏?

```sql
SELECT
    u.id,
    u.name,
    u.telegram_id,
    ce.is_active,
    tc.name as category
FROM users u
JOIN category_executors ce ON u.id = ce.user_id
JOIN ticket_categories tc ON ce.ticket_category_id = tc.id
WHERE ce.is_active = true
ORDER BY tc.name, u.name;
```

**–û–∂–∏–¥–∞–µ–º–æ–µ**: –•–æ—Ç—è –±—ã 1 –∞–∫—Ç–∏–≤–Ω—ã–π –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å —Å –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º `telegram_id`

### –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è listener'–æ–≤

```php
// –í app/Providers/EventServiceProvider.php
protected $listen = [
    // ...
    TicketCreated::class => [
        SendTicketCreatedTelegramNotification::class,      // ‚Üê –ê–≤—Ç–æ—Ä—É
        SendTicketCreatedNotificationToExecutors::class,   // ‚Üê –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è–º (–ù–û–í–û–ï!)
    ],
    // ...
];
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: –†–∞–±–æ—Ç–∞–µ—Ç –ª–∏ –æ—á–µ—Ä–µ–¥—å?

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–¥–∞—á–∏ –≤ –æ—á–µ—Ä–µ–¥–∏
php artisan queue:monitor notifications

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å failed jobs
php artisan queue:failed
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

–°–æ–∑–¥–∞–Ω–Ω—ã–µ/–∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:

```
app/
‚îú‚îÄ‚îÄ Services/
‚îÇ   ‚îî‚îÄ‚îÄ Telegram/
‚îÇ       ‚îî‚îÄ‚îÄ TicketWorkflowService.php          ‚Üê –ù–û–í–´–ô (–ª–æ–≥–∏–∫–∞ workflow)
‚îú‚îÄ‚îÄ Listeners/
‚îÇ   ‚îî‚îÄ‚îÄ SendTicketCreatedNotificationToExecutors.php  ‚Üê –ù–û–í–´–ô (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è)
‚îú‚îÄ‚îÄ Services/Telegram/Handlers/
‚îÇ   ‚îî‚îÄ‚îÄ CallbackQueryHandler.php               ‚Üê –ò–ó–ú–ï–ù–ï–ù (–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫)
‚îú‚îÄ‚îÄ Console/Commands/
‚îÇ   ‚îú‚îÄ‚îÄ TelegramBotPolling.php                ‚Üê –ò–ó–ú–ï–ù–ï–ù (–¥–æ–±–∞–≤–ª–µ–Ω workflow)
‚îÇ   ‚îî‚îÄ‚îÄ TestExecutorNotifications.php          ‚Üê –ù–û–í–´–ô (—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
‚îî‚îÄ‚îÄ Providers/
    ‚îî‚îÄ‚îÄ EventServiceProvider.php               ‚Üê –ò–ó–ú–ï–ù–ï–ù (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è listener)

docs/
‚îú‚îÄ‚îÄ EXECUTOR_NOTIFICATIONS.md                  ‚Üê –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
‚îú‚îÄ‚îÄ TICKET_WORKFLOW_TELEGRAM.md               ‚Üê –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è workflow
‚îî‚îÄ‚îÄ QUICK_START_WORKFLOW.md                   ‚Üê –≠—Ç–æ—Ç —Ñ–∞–π–ª
```

## –õ–æ–≥–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

```bash
# –°–ª–µ–¥–∏—Ç—å –∑–∞ –ª–æ–≥–∞–º–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
tail -f storage/logs/laravel.log

# –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ keyword
tail -f storage/logs/laravel.log | grep -E "ticket|executor|workflow"

# –ù–∞–π—Ç–∏ –æ—à–∏–±–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
grep "Failed to send notification to executor" storage/logs/laravel.log
```

## –¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ –∏ —Ä–µ—à–µ–Ω–∏—è

### ‚ùå –ö–Ω–æ–ø–∫–∏ –Ω–µ —Ä–µ–∞–≥–∏—Ä—É—é—Ç

**–ü—Ä–∏—á–∏–Ω–∞**: –ë–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω –∏–ª–∏ CallbackQueryHandler –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω

**–†–µ—à–µ–Ω–∏–µ**:
```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
php artisan telegram:polling
```

### ‚ùå –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**–ü—Ä–∏—á–∏–Ω–∞**: –û—á–µ—Ä–µ–¥—å –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ**:
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å worker
php artisan queue:work --queue=notifications
```

### ‚ùå "–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —ç—Ç—É –∑–∞—è–≤–∫—É"

**–ü—Ä–∏—á–∏–Ω–∞**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏

**–†–µ—à–µ–Ω–∏–µ**:
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å /executors
# –ò–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é:
INSERT INTO category_executors (user_id, ticket_category_id, is_active, priority, max_tickets)
VALUES (5, 2, true, 5, 10);
```

### ‚ùå "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω"

**–ü—Ä–∏—á–∏–Ω–∞**: –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç telegram_id

**–†–µ—à–µ–Ω–∏–µ**:
```bash
# –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –æ—Ç–ø—Ä–∞–≤–∏—Ç—å /start –±–æ—Ç—É
# –ò–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é:
UPDATE users SET telegram_id = '123456789' WHERE id = 5;
```

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:

1. **Production deployment**:
   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ Supervisor –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ –∏ –æ—á–µ—Ä–µ–¥–µ–π
   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (Sentry/Bugsnag)

2. **–û–±—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**:
   - –ü—Ä–æ–≤–µ–¥–∏—Ç–µ –¥–µ–º–æ –¥–ª—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π
   - –û–±—ä—è—Å–Ω–∏—Ç–µ —á—Ç–æ –¥–µ–ª–∞—Ç—å —Å –∫–Ω–æ–ø–∫–∞–º–∏
   - –ü–æ–∫–∞–∂–∏—Ç–µ –∫–∞–∫ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∑–∞—è–≤–∫–∏

3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**:
   - –°–ª–µ–¥–∏—Ç–µ –∑–∞ –ª–æ–≥–∞–º–∏ –ø–µ—Ä–≤—ã–µ –¥–Ω–∏
   - –°–æ–±–µ—Ä–∏—Ç–µ feedback –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   - –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏**: `tail -f storage/logs/laravel.log`
2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å—ã**: `ps aux | grep -E "telegram|queue"`
3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ë–î**: SQL –∑–∞–ø—Ä–æ—Å—ã –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ "–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"
4. **–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏**: `docs/TICKET_WORKFLOW_TELEGRAM.md`

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è**: 17.11.2024
**–í–µ—Ä—Å–∏—è**: 1.0
